<!DOCTYPE html><html lang="ja"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width">

<canvas id="chart"></canvas>

<script type="module">
import { CBOR } from "https://js.sabae.cc/CBOR.js";
import { fetchBin } from "https://js.sabae.cc/fetchBin.js";
import Chart from "https://js.sabae.cc/Chart.mjs";

onload = async () => {
  const data = await CBOR.decode(await fetchBin("https://code4fukui.github.io/influenza/influenza_mhlw_go_jp.csv.cbor"));
  console.log(data);

  const date = [];
  const datasets = [];
  for (let j = 1; j < data[0].length; j++) {
    const hue = 30;
    const dset = {
      label: data[0][j],
      type: "line",
      data: [],
      fill: false,
      lineTension: 0,
      yAxisID: "yr",
      borderColor: `hsl(${hue}, ${j * 20}%, 50%)`,
    };
    datasets.push(dset);
  }
  for (let i = 1; i < data.length; i++) {
    const d = data[i];
    date.push(d[0]);
    const fix = (n) => {
      if (n == "" || n == "-") {
        return null;
      }
      /*
      if (n == "-") {
        return 0;
      }
      */
      return n.replace(/,/g, "");
    };
    for (let j = 1; j < d.length; j++) {
      datasets[j - 1].data.push(fix(d[j]));
    }
  }
  const config = {
    data: {
      labels: date,
      datasets,
      /*
      : [
        { type: "line", data: data1, borderColor: 'rgb(255, 99, 132)', fill: false, lineTension: 0, yAxisID: "yl" },
        { type: "bar", data: data2, backgroundColor: 'rgb(99, 255, 132)', fill: false, lineTension: 0, yAxisID: "yr" }
      ]
      */
    },
    options: {
      title: { display: true, text: "日本のインフルエンザ報告" },
      scales: {
        xAxes: [{ scaleLabel: { display: true, labelString: "週" } }],
        yAxes: [
          { id: "yr", position: "right", scaleLabel: { display: true, labelString: "報告数" }, ticks: { beginAtZero: true } },
          //{ id: "yl", position: "left", scaleLabel: { display: true, labelString: "PCR 検査陽性者数" }, ticks: { beginAtZero: true } },
        ],
      },
      legend: { display: true }
    }
  };
  new Chart.Chart(chart, config);
};
</script>
